dist: trusty
services: docker

language: rust
rust:
  - beta

env:
  global:
    - PACKAGE_NAME=twitchdl
    - BIN_NAME=twitchdl,m3u8

matrix:
  include:
    # Linux
    - env: TARGET=x86_64-unknown-linux-gnu
    - env: TARGET=x86_64-unknown-linux-musl
    # OSX
    - env: TARGET=x86_64-apple-darwin
      os: osx
    # Windows
    - env: TARGET=x86_64-pc-windows-gnu

notifications:
  email: false

branches:
  only:
    - master

cache: cargo

before_cache:
  - bash ci/before_cache.sh

before_install:
  - rustup self update

install:
  - bash ci/install.sh
  - source ~/.cargo/env || true

script:
  - bash ci/build.sh

after_success:
  - files=$(ls target/$TARGET/release)
  - echo $files

before_deploy:
  - export RELEASE_NAME=$(date +%m.%d.)$(git show -s --format=%ct $TRAVIS_COMMIT)
  - bash ci/before_deploy.sh

deploy:
  name: $RELEASE_NAME
  body: Automatically generated by Travis CI and AppVeyor
  prerelease: true
  provider: releases
  skip_cleanup: true
  api_key:
    secure: "I38L0gNkS87/utnuLP8nfY/TB5Squ5MH8lWvyVhFp3WF3BSiRyLT2YSDIc1qPfnZQmWzNQ+8Vfx7Z5Ta96uD/NuIDwLbfARvJaAi5blAA5ITy3pnqZFxtCk2NALdjV6ADTiXMadCH2RF7iSbUaPegmgRmH+jVK+jHCzK3Mk9DEh8zQBlTYcccBeKzoWKh5s1o/JIgk2JzNs1yH7WTvmb/fELYsljctlau/lHhMx59TzSjQUYkHufiCJ0bs/8dgkugRjojX/+US3QZHX0/uWRKub2fF/gcHCYU7/u5roHr6U2RT5IdNzJm6+u3i6Bm7hwKqdFALbPlVdvCQOGBFUBxM7dmhsW0kcmv8dXs8+2mz30Zwj58j3GHB2pd+iW0a3HafNZVWT7fVrq4VYPPtGS1NpZHLlm/tTN0iv+lv6/YSkAWATxyZddfzgIBNYULSL93aecuqo6aoN5IzJy6yq/a2IEeLIaK3HaZMpstZwDVcRvDe8nEpj/y+WjPYztCdwT5uYQpRdSvpemSDyvC2/V5TX5kXXNgOwBG2Eur1zTD63gVdqlQlBySDodRDjc+4YaJDko6ho4hAX25vnUKuMkpkSdYOoJwyrIRrvIoDz5LoEyC8Pld8q4o5u4rGMtKWJrOZg9nVhSVv0bdfWo2JnJKShgbi/er9iGhpeamEziw9s="
  file:
    - $PACKAGE_NAME-$TARGET-RELEASE.zip
    - $PACKAGE_NAME-$TARGET-DEBUG.zip
  on:
    repo: sylingd/TD
    tags: false