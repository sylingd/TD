dist: trusty
services: docker

language: rust
rust:
  - beta

env:
  global:
    - PACKAGE_NAME=twitchdl
    - BIN_NAME=twitchdl,m3u8

matrix:
  include:
    # Linux
    - env: TARGET=x86_64-unknown-linux-gnu
    - env: TARGET=x86_64-unknown-linux-musl
    # OSX
    - env: TARGET=x86_64-apple-darwin
      os: osx
    # Windows
    - env: TARGET=x86_64-pc-windows-gnu

notifications:
  email: false

branches:
  only:
    - master

cache: cargo

before_cache:
  - bash ci/before_cache.sh

before_install:
  - rustup self update

install:
  - bash ci/install.sh
  - source ~/.cargo/env || true

script:
  - bash ci/build.sh

after_success:
  - files=$(ls target/$TARGET/release)
  - echo $files

before_deploy:
  - export RELEASE_NAME=$(date +%m.%d.)$(git show -s --format=%ct $TRAVIS_COMMIT)
  - bash ci/before_deploy.sh

deploy:
  name: $RELEASE_NAME
  body: Automatically generated by Travis CI and AppVeyor
  prerelease: true
  provider: releases
  skip_cleanup: true
  api_key:
    secure: "eCtLKqK2paxbaWi0+YuyPRkqQEl9waZK9JrKAhOZSXd2e2Mfo3N017TOXuhi5WrszfO8oQne50z3wV4t7lsUOtlN/d0mUg3urm8tlEixTeqSMIRl3L5e+vGnRIE4IFr3yPRL6Tq8Y+5MGi8vPHyHqruDcfH/Ym9ykh7uFUrdTKMm+4lmJ/MWmmF+3w6ma8Xot7idV4O1petBukD8deSZyz0YEFoj4pM15HGIcoq3ec17s06QlsjaN1FIHW5FeNXzFCGC6MdJL+Hst87fGgJ6A4DhwHV8WQj+97cdcxZgxBXPJejuDvfAC/x8iFd1uG9KxUCCbOcWehOun4r6f4GSBq5h7vR0BRw1qcd+TQKLc/sVsFHBwNh4HBQK8uR6R9VGr/3pnPRALzBr//AbsEiQqm9lW6RjPwPmssgMhZBlSLQCGiYZkP/zdhKkgRNGiD4B2JfTtwLp4EWAI84cqTtjeNHagU/HF0q7KpnG4mWBQ2mY4A3tdakYEI29TdXfB62jq+kPu/Av06AT5pPEuqtKIEn400nkt5kDMeFJnhO+F3OypldugMNGU1lLvtmy23mi4zi3bFngfap6Z4QtUWTJXhZ/ILV5fcQ3H5zHEePVj7eUHy+X0OJCw9dxmtQyT/f8JuvDl8mrWt3fx+z4Dx9OdAI3+hPeFavOzTqTzH6a/nc="
  file:
    - $PACKAGE_NAME-$TARGET-RELEASE.zip
    - $PACKAGE_NAME-$TARGET-DEBUG.zip
  on:
    repo: sylingd/TD
    tags: false